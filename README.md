# Language Detection with Lingua (Rust) and Go

## Overview
This project demonstrates how to use the [Lingua](https://github.com/pemistahl/lingua-rs) language detection library (written in Rust) from Go code using CGO (C Go). It provides a high-performance, extensible, and accurate language detection solution for Go applications by leveraging Rust's mature Lingua library.

---

## How It Works

### Architecture
- **Rust FFI Library** (`rust/src/lib.rs`): Wraps Lingua's detection functions in a C-compatible interface using `#[no_mangle] extern "C"`.
- **C Header** (`rust/target/release/lingua_ffi.h`): Generated by [cbindgen](https://github.com/mozilla/cbindgen), describes the Rust FFI for CGO.
- **Go CGO Interface** (`internal/lingua/lingua.go`): Uses `import "C"` to call Rust functions as if they were C functions.
- **Build System**: Uses Cargo for Rust, Go modules for Go, and a Makefile to orchestrate builds.

**Flow:**
1. Go code calls a function (e.g., `DetectLanguage`) via CGO.
2. CGO calls the Rust FFI function in the compiled shared library.
3. Rust code uses Lingua to detect the language and returns the result to Go.

---

## Project Structure
```
language-detection-go/
├── cmd/
│   └── lingua-detector/
│       └── main.go              # Main CLI application
├── internal/
│   └── lingua/
│       └── lingua.go            # Core library code with CGO bindings
├── pkg/
│   └── lingua/
│       └── lingua_test.go       # Comprehensive test suite
├── rust/
│   ├── src/
│   │   └── lib.rs               # Rust FFI library wrapping Lingua
│   ├── Cargo.toml               # Rust dependencies
│   ├── build.rs                 # Rust build script for cbindgen
│   └── cbindgen.toml            # cbindgen config for C header
├── docs/
│   ├── ARCHITECTURE.md          # Detailed architecture documentation
│   ├── DEVELOPMENT.md           # Development guidelines
│   └── TODO.md                  # Project roadmap
├── scripts/
│   └── build.sh                 # Build automation script
├── Makefile                     # Build automation
├── go.mod                       # Go dependencies
├── README.md                    # This documentation
└── rust/target/release/         # Compiled Rust library and header
```

---

## Building and Running

### Prerequisites
- Go 1.21+
- Rust (with Cargo)
- cbindgen (`cargo install cbindgen`)
- A C compiler (gcc/clang)

### Build Steps
```sh
# Option 1: Use the build script (recommended)
./scripts/build.sh

# Option 2: Use the Makefile
make build

# Option 3: Manual build
# 1. Build the Rust library and header
cd rust
cargo build --release
cbindgen --config cbindgen.toml --crate lingua-ffi --output target/release/lingua_ffi.h
cd ..

# 2. Build the Go application
go build -o lingua-detector cmd/lingua-detector/main.go

# 3. Run the Go application
./lingua-detector
```

### Running Tests
```sh
# Run all tests
go test ./...

# Run specific test package
go test ./pkg/lingua

# Run with verbose output
go test -v ./pkg/lingua
```

---

## Adding More Languages
1. **Edit `rust/src/lib.rs`:**
   - Add more `Language::Xxx,` entries to the `languages` vector in both FFI functions.
   - See [Lingua's supported languages](https://github.com/pemistahl/lingua-rs#supported-languages).
2. **Rebuild:**
   ```sh
   ./scripts/build.sh
   ```

---

## Adding More Tests
1. **Edit `pkg/lingua/lingua_test.go`:**
   - Add new test cases to the appropriate test functions or create new ones.
   - For SEA or mixed-language input, see the provided examples.
2. **Run tests:**
   ```sh
   go test -v ./pkg/lingua
   ```

---

## Development

### Code Organization
- **`cmd/lingua-detector/`**: Contains the main CLI application
- **`internal/lingua/`**: Contains the core library code with CGO bindings
- **`pkg/lingua/`**: Contains the public API and tests
- **`rust/`**: Contains all Rust-related code and configuration
- **`docs/`**: Contains project documentation
- **`scripts/`**: Contains build and utility scripts

### Adding New FFI Functions
- Add a new `#[no_mangle] extern "C" fn ...` in `rust/src/lib.rs`.
- Regenerate the header with cbindgen.
- Add a Go wrapper method in `internal/lingua/lingua.go`.

### Example: Adding a Function to List Supported Languages
1. In `rust/src/lib.rs`:
   ```rust
   #[no_mangle]
   pub extern "C" fn supported_languages() -> *mut c_char {
       let langs = vec!["English", "Spanish", ...];
       CString::new(langs.join(",")).unwrap().into_raw()
   }
   ```
2. Regenerate the header and add a Go wrapper in `internal/lingua/lingua.go`.

---

## Troubleshooting
- **Header not found:** Ensure `lingua_ffi.h` is in `rust/target/release/` and matches the built library.
- **Linker errors:** Check that `liblingua_ffi.dylib` (macOS) or `.so` (Linux) is in `rust/target/release/`.
- **Test failures:** Some short or ambiguous phrases may be misclassified; try longer or more distinctive sentences.
- **CGO errors:** Ensure all build steps are run from the project root and environment variables are set (e.g., `source $HOME/.cargo/env`).

---

## Contributing
1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add/expand tests
5. Submit a pull request

---

## License
MIT
